{% load static %}

<div class="card mb-4">
    <div class="card-header bg-primary text-white">
        <h5 class="mb-0"><i class="bi bi-diagram-3"></i> Outcome Mapping Graph</h5>
    </div>
    <div class="card-body">
        <div id="cy" style="width: 100%; height: 600px; border: 1px solid #e5e7eb; border-radius: 8px; background: #ffffff;"></div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.26.0/cytoscape.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape-dagre/2.5.0/cytoscape-dagre.min.js"></script>
<script>
// Register dagre extension when scripts load
// The CDN version from cdnjs may export it differently, so we check multiple possibilities
(function registerDagre() {
    if (typeof cytoscape === 'undefined') {
        // Wait a bit for cytoscape to load
        setTimeout(registerDagre, 100);
        return;
    }
    
    // Try to find and register dagre extension
    if (typeof cytoscapeDagre !== 'undefined') {
        try {
            cytoscape.use(cytoscapeDagre);
        } catch (e) {
            console.warn('Dagre registration failed:', e);
        }
    }
})();

document.addEventListener('DOMContentLoaded', function() {
    try {
        const graphData = {{ graph_data }};
        
        if (!graphData || !graphData.nodes || graphData.nodes.length === 0) {
            document.getElementById('cy').innerHTML = '<div class="alert alert-info m-3">No graph data available. Add assessments, learning outcomes, and connections to see the graph.</div>';
            return;
        }
    
    // Use breadthfirst layout (always available in Cytoscape)
    // This ensures the graph displays even if dagre fails to load
    const layoutConfig = {
        name: 'breadthfirst',
        directed: true,
        spacingFactor: 1.5
    };
    
    // Initialize Cytoscape
    const cy = cytoscape({
        container: document.getElementById('cy'),
        elements: [
            // Add nodes
            ...graphData.nodes.map(node => ({
                data: {
                    id: node.id,
                    label: node.label,
                    type: node.type,
                    ...node.data
                }
            })),
            // Add edges
            ...graphData.edges.map(edge => ({
                data: {
                    id: edge.id,
                    source: edge.source,
                    target: edge.target,
                    label: edge.label || `${(edge.weight * 100).toFixed(0)}%`,
                    weight: edge.weight,
                    type: edge.type
                }
            }))
        ],
        style: [
            {
                selector: 'node[type="assessment"]',
                style: {
                    'shape': 'diamond',
                    'background-color': '#0891b2',
                    'label': 'data(label)',
                    'color': '#ffffff',
                    'width': 85,
                    'height': 85,
                    'text-valign': 'center',
                    'text-halign': 'center',
                    'font-size': '12px',
                    'font-weight': '600',
                    'border-width': 2,
                    'border-color': '#0e7490'
                }
            },
            {
                selector: 'node[type="learning_outcome"]',
                style: {
                    'shape': 'round-rectangle',
                    'background-color': '#059669',
                    'label': 'data(label)',
                    'color': '#ffffff',
                    'width': 110,
                    'height': 65,
                    'text-valign': 'center',
                    'text-halign': 'center',
                    'font-size': '11px',
                    'font-weight': '600',
                    'border-width': 2,
                    'border-color': '#047857'
                }
            },
            {
                selector: 'node[type="program_outcome"]',
                style: {
                    'shape': 'round-rectangle',
                    'background-color': '#6366f1',
                    'label': 'data(label)',
                    'color': '#ffffff',
                    'width': 110,
                    'height': 65,
                    'text-valign': 'center',
                    'text-halign': 'center',
                    'font-size': '11px',
                    'font-weight': '600',
                    'border-width': 2,
                    'border-color': '#4f46e5'
                }
            },
            {
                selector: 'edge',
                style: {
                    'width': 2,
                    'line-color': '#9ca3af',
                    'target-arrow-color': '#6b7280',
                    'target-arrow-shape': 'triangle',
                    'target-arrow-size': 8,
                    'curve-style': 'bezier',
                    'label': 'data(label)',
                    'text-rotation': 'autorotate',
                    'text-margin-y': -10,
                    'font-size': '10px',
                    'font-weight': '600',
                    'color': '#1f2937',
                    'text-background-color': '#ffffff',
                    'text-background-opacity': 0.95,
                    'text-background-padding': '3px',
                    'text-border-color': '#e5e7eb',
                    'text-border-width': 1
                }
            },
            {
                selector: 'edge[type="assessment_to_lo"]',
                style: {
                    'line-color': '#0891b2',
                    'target-arrow-color': '#0e7490',
                    'width': 2.5
                }
            },
            {
                selector: 'edge[type="lo_to_po"]',
                style: {
                    'line-color': '#6366f1',
                    'target-arrow-color': '#4f46e5',
                    'width': 2.5
                }
            }
        ],
        layout: layoutConfig
    });
    
    // Add tooltips on hover
    cy.on('mouseover', 'node', function(evt) {
        const node = evt.target;
        const type = node.data('type');
        let tooltip = node.data('label');
        
        if (type === 'assessment') {
            const weight = node.data('weight');
            if (weight !== undefined) {
                tooltip += `\nWeight: ${(weight * 100).toFixed(1)}%`;
            }
            const grade = node.data('grade');
            if (grade !== undefined) {
                tooltip += `\nGrade: ${grade.toFixed(1)}%`;
            }
        } else if (type === 'learning_outcome') {
            const description = node.data('description');
            if (description) {
                tooltip += `\n${description}`;
            }
            const score = node.data('score');
            if (score !== undefined) {
                tooltip += `\nScore: ${score.toFixed(1)}%`;
            }
        } else if (type === 'program_outcome') {
            const description = node.data('description');
            if (description) {
                tooltip += `\n${description}`;
            }
            const score = node.data('score');
            if (score !== undefined) {
                tooltip += `\nScore: ${score.toFixed(1)}%`;
            }
        }
        
        // Create tooltip element
        const tooltipEl = document.createElement('div');
        tooltipEl.className = 'graph-tooltip';
        tooltipEl.style.cssText = 'position: absolute; background: rgba(255, 255, 255, 0.98); color: #1f2937; padding: 10px 14px; border-radius: 8px; font-size: 12px; pointer-events: none; z-index: 1000; white-space: pre-line; border: 1px solid #0891b2; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); font-weight: 500;';
        tooltipEl.textContent = tooltip;
        document.body.appendChild(tooltipEl);
        
        const updateTooltip = (e) => {
            tooltipEl.style.left = (e.pageX + 10) + 'px';
            tooltipEl.style.top = (e.pageY - 10) + 'px';
        };
        
        document.addEventListener('mousemove', updateTooltip);
        node.on('mouseout', function() {
            document.removeEventListener('mousemove', updateTooltip);
            tooltipEl.remove();
        });
    });
    
    // Fit the graph to the container
    cy.fit();
    } catch (error) {
        console.error('Error rendering graph:', error);
        document.getElementById('cy').innerHTML = '<div class="alert alert-danger m-3">Error rendering graph. Please check the browser console for details.</div>';
    }
});
</script>

<style>
.graph-tooltip {
    position: absolute;
    background: rgba(255, 255, 255, 0.98);
    color: #1f2937;
    padding: 10px 14px;
    border-radius: 8px;
    font-size: 12px;
    pointer-events: none;
    z-index: 1000;
    white-space: pre-line;
    border: 1px solid #0891b2;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    font-weight: 500;
}
</style>

