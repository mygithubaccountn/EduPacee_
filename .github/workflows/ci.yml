name: Django CI

on:
  push:
  pull_request:

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Show repository structure
        run: |
          pwd
          ls -la
          find . -maxdepth 4 -type f -name "manage.py" || echo "manage.py not found"
          find . -maxdepth 4 -type f -name "requirements.txt" || echo "requirements.txt not found"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            echo "Warning: requirements.txt not found, installing basic Django"
            pip install django
          fi

      - name: Run Django system check
        env:
          DJANGO_SETTINGS_MODULE: Eduu_Pace.settings
        run: |
          if [ -f manage.py ]; then
            python manage.py check || exit 1
          else
            echo "Error: manage.py not found at repo root"
            exit 1
          fi

      - name: Run database migrations
        env:
          DJANGO_SETTINGS_MODULE: Eduu_Pace.settings
        run: |
          if [ -f manage.py ]; then
            python manage.py migrate --noinput || exit 1
          else
            echo "Error: manage.py not found"
            exit 1
          fi

      - name: Run Django tests
        env:
          DJANGO_SETTINGS_MODULE: Eduu_Pace.settings
        run: |
          if [ -f manage.py ]; then
            # Run tests - exit code 0 if tests pass or no tests found
            python manage.py test edupace_app --verbosity=2
            TEST_EXIT_CODE=$?
            if [ $TEST_EXIT_CODE -eq 0 ]; then
              echo "✅ Tests passed or no tests found"
            else
              echo "❌ Tests failed with exit code $TEST_EXIT_CODE"
              exit 1
            fi
          else
            echo "Error: manage.py not found"
            exit 1
          fi
